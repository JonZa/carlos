#!/bin/bash
# Carlos Ultra Setup - Creates the ULTRASIMPLE test environment

set -e

echo "ðŸš€ Carlos Ultra Test Setup"
echo "=========================="

TARGET_DIR="${1:-$(pwd)}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ðŸ“ Setting up Carlos Ultra in: $TARGET_DIR"
cd "$TARGET_DIR"

# Create the ULTRASIMPLE carlos.md
cat > carlos.md << 'EOF'
# Carlos Ultra Tasks

[ ] html-service: Create index.html with "bloop bloop"
[ ] css-service: Create styles.css with body{font-family:monospace} (after: html-service)
[ ] js-service: Create main.js with console.log("bleep bleep") (after: css-service)
EOF

echo "âœ… Created carlos.md with ultra-simple tasks"

# Create test repositories
REPOS=(
    "html-service:HTML Service"
    "css-service:CSS Service" 
    "js-service:JavaScript Service"
)

for repo_info in "${REPOS[@]}"; do
    IFS=':' read -r repo_name repo_desc <<< "$repo_info"
    
    echo ""
    echo "ðŸ”§ Setting up $repo_name..."
    
    # Create directory
    mkdir -p "$repo_name"
    cd "$repo_name"
    
    # Initialize git
    if [ ! -d ".git" ]; then
        git init
        
        # Create package.json for naming
        cat > package.json << EOF
{
  "name": "$repo_name",
  "version": "1.0.0",
  "description": "$repo_desc for Carlos Ultra testing"
}
EOF

        # Create basic README
        cat > README.md << EOF
# $repo_desc

This is a Carlos Ultra test service.

## ðŸ¤– For AI Agents

**ONLY command you need:**
\`\`\`bash
.carlos/work
\`\`\`

## ðŸ“‹ EXACT Steps:

1. Run \`.carlos/work\`
2. Read your task description  
3. **ACTUALLY CREATE THE FILES** (write the code!)
4. When asked, choose:
   - **1** = YES, I implemented it (mark DONE)
   - **2** = NO, I'll check later

## âš ï¸ CRITICAL:

**Only choose option 1 if you ACTUALLY wrote the code files!**

- âœ… Created the file with correct content â†’ Press 1
- âŒ Just read the task but didn't code â†’ Press 2

Don't just read - implement first, then mark done.

**Agent: $repo_name**
EOF

        git add .
        git commit -m "Initial $repo_name setup"
        echo "   âœ… Git repository initialized"
    fi
    
    # Install Carlos Ultra
    echo "   ðŸ”§ Installing Carlos Ultra agent..."
    "$SCRIPT_DIR/carlos-ultra-init.sh"
    
    cd ..
done

echo ""
echo "ðŸŽ‰ Carlos Ultra Test Environment Complete!"
echo "=========================================="
echo ""
echo "ðŸ“‹ Created tasks:"
echo "   1. html-service: Create index.html with 'bloop bloop'"
echo "   2. css-service: Create styles.css with body{font-family:monospace}"  
echo "   3. js-service: Create main.js with console.log('bleep bleep')"
echo ""
echo "ðŸš€ To test:"
echo "   cd html-service"
echo "   .carlos/work"
echo ""
echo "ðŸ’¡ Each agent only has ONE command: .carlos/work"
echo "ðŸ’¡ Check overall status with: .carlos/status (from any agent)"
echo ""
echo "ðŸ“Š View tasks: cat carlos.md"